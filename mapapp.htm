<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Map App</title>
		<meta name="author" content="Andre Britton">
		<link href="css/leaflet.css" rel="stylesheet">
	<!-- Bootstrap core CSS --> 
		<link href="css/bootstrap.css" rel="stylesheet"> 
	<!-- Bootstrap theme --> 
		<link href="css/bootstrap-theme.css" rel="stylesheet">
	</head>
	<body role="document">
		<div class="container-fluid" role="main">
			<div>
				<h1 class="jumbotron">Client Mapping Tool</h1>
			</div>
			<div class="panel-group" id="mapHolder">
				<div class="panel panel-default">
					<div class="panel panel-heading">
						<h4 class="panel-title">
							<a data-toggle="collapse" data-target="#loadDiv">
							Upload Data
							</a>
						</h4>
					</div>
					<div class="collapse" id="loadDiv">
						<div class="panel panel-body">
							<input type=file id="file" name="file" class="btn btn-default">
							<input type=button class="btn btn-info" value="Submit Data" onclick="submitData()">
						</div>
					</div>
				</div>
				<div class="panel panel-default">
					<div class="panel panel-heading">
						<h4 class="panel-title">
							<a data-toggle="collapse" data-target="#mapDiv">
								Map
							</a>
						</h4>
					</div>
					<div class="collapse in" id="mapDiv">
						<div class="panel panel-body">
							<div id="map" style="height: 500px;">
							</div>
						</div>
					</div>
				</div>
				<div class="panel panel-default">
					<div class="panel panel-heading">
						<h4 class="panel-title">
							<a data-toggle="collapse" data-target="#optDiv">
							Options
							</a>
						</h4>
					</div>
					<div class="collapse" id="optDiv">
						<div class="panel panel-body">
							<p>
								Options to go here.
							</p>
							<div class="well" id="PCODEWELL">
								<h3>
									Post Code Data
								</h3>
								<textarea id="PCODES" name="PCODES" style="width: 100%; height: 400px;"></textarea>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script src="js/jquery.min.js"></script>
		<script src="js/jquery.csv-0.71.js"></script>
		<script src="js/leaflet.js"></script>
		<script src="js/leaflet-src.js"></script>
		<script src="js/tile.stamen.js"></script>
		<!--Bootstrap Script -->
		<script src="js/bootstrap.js"></script>
		<script>
			var mapLong = 0.7;
			var mapLat = 51.1;
			var mapZoom = 9;
			var map = L.map("map").setView([mapLat, mapLong],mapZoom);
			var layer = new L.StamenTileLayer("toner");
			layer.addTo(map);
			map.attributionControl.addAttribution('Map tiles by <a href="http://stamen.com">Stamen Design</a>, under <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a>. Data by <a href="http://openstreetmap.org">OpenStreetMap</a>, under <a href="http://www.openstreetmap.org/copyright">ODbL</a>.');
			//L.tileLayer("http://a.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>'}).addTo(map);
			
			function submitData(){
				var files = document.getElementById("file").files;
				var file = files[0];
				var reader = new FileReader();
				reader.readAsText(file);
				reader.onload = function (event) {
						var csv = event.target.result;
						var data = $.csv.toArrays(csv);
						loadData(data);
				}
				reader.onerror = function (event){
					alert("Unable to read "+file.filename);
				}
			}
			
			function loadData(data){
				var builtArray = arrayBuilder(data);
				var pCodes = loadPCodes();
				var codedArray = addCoOrds(builtArray,pCodes);
				plotPoints(codedArray);
			}
			
			function plotPoints(codedArray){
				var providers = L.layerGroup();
				var providerlist = {};
				for(row in codedArray){
					if(codedArray[row]["lat"] == null){
						alert("Cannot find Lat/Long data for: "+codedArray[row]["SWIFT ID"]+" @ "+codedArray[row]["Post Code"]);
					}
					var circle = L.circle([codedArray[row]["lat"], codedArray[row]["lng"]],1);
					var name = codedArray[row]["Provider"];
					circle.bindPopup(name);
					if(providers.hasLayer(this [name])){
						this[name].addLayer(circle);
					}
					else{
						this[name] = L.layerGroup();
						providers.addLayer(this[name]);
						this[name].addLayer(circle);
						providerlist[name] = this [name];
					}
				}
				providers.addTo(map);
				L.control.layers(null, providerlist).addTo(map);
			}
			
			function arrayBuilder(data){
				var dataArray = [];
				for(row in data){
					if(row != 0){
						var arrayPart = {};
						var list = data[row];
						for (item in list){
							arrayPart[labels[item]] = list[item];
						}
						dataArray.push(arrayPart);
					}
					else{
						var labels = data[row];
					}
				}
				return dataArray;
			}
			
			function loadPCodes(){
				var rawData = document.getElementById("PCODES").value;
				var rawArray = rawData.split("\n");
				var masterArray = [];
				for (line in rawArray){
					var chunk = rawArray[line];
					if(line == 0){
						var headers = chunk.split("\t");
					}
					else{
						var subObject = {};
						var values = chunk.split("\t");
						for(number in values){
							subObject[headers[number]] = values[number];
						}
						masterArray.push(subObject);
					}
				}
				return masterArray;
			}
			
			function addCoOrds(builtArray,pCodes){
				for (row in builtArray){
					var line = builtArray[row];
					if(line["Post Code"] != ""){
						var lineCode = line["Post Code"];
						if (lineCode.indexOf(" ") != -1){
							var straightCode = lineCode.replace(" ","");
						}
						for(search in pCodes){
							var searcher  = pCodes[search];
							if(straightCode == searcher["PCODE"]){
								if(searcher["lat"] != ""){
									line["lat"] = Number(searcher["lat"]);
								}
								if(searcher["lng"] != ""){
									line["lng"] = Number(searcher["lng"]);
								}
								if(searcher["MSOA"] != ""){
									line["MSOA"] = searcher["MSOA"];
								}
								if(searcher["CCG"] != ""){
									line["CCG"] = searcher["CCG"];
								}
							}
						}
						if(builtArray[row]["lat"] == 0){
							alert("Cannot find data for "+line["SWIFT ID"]);
							delete line;
						}
						if(builtArray[row]["lng"] == 0){
							alert("Cannot find data for "+line["SWIFT ID"]);
							delete line;
						}
					}
				}
				return builtArray;
			}
		</script>
	</body>
</html>
