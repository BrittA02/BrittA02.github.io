<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Social Care Mapping Tool</title>
		<tracking>
		<meta name="author" content="apb21">
	<!-- Leaflet CSS --> 
		<link href="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" rel="stylesheet">
	<!-- Font Awesome CSS --> 
		<link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
	<!-- Bootstrap core CSS --> 
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet"> 
	<!-- Bootstrap theme --> 
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css" rel="stylesheet">
	</head>
	<body role="document">
		<nav class="navbar navbar-fixed-top">
			<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
			            <span class="sr-only">Toggle navigation</span>
			            <span class="fa-stack fa-3x">
							<i class="fa fa-square fa-stack-2x" aria-hidden="true"></i>
							<i class="fa fa-th fa-stack-1x fa-inverse" aria-hidden="true"></i>
			            </span>
					</button>
					<a href="http://www.nhs.uk" class="navbar-brand" target="_blank">
						<img alt="Supplied by NHS Choices" src="http://blogs.nhs.uk/choices-blog/files/2014/02/logo_content_supplied.jpg">
					</a>
				</div>
				<div id="navbar" class="collapse navbar-collapse">
					<form class="navbar-form navbar-right" action="javascript: codeLookup()" role="search">
						<div class="form-group">
							<input type="text" id="searchCode" class="form-control" placeholder="Search for a Postcode..">
							<button type="submit" id="searchButton" class="btn btn-warning form-control">Search</button>
						</div>
					</form>
				</div>
			</div>
		</nav>
		<div class="container-fluid leaflet-container leaflet-fade-anim" role="main" id="map">
		</div>
		<!-- JQuery Dependancy -->
			<script src="http://code.jquery.com/jquery-1.9.1.js"></script>
		<!-- Leaflet Script -->
			<script src="http://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.js"></script>
		<!-- Stamen map tiles Script -->
			<script src="http://maps.stamen.com/js/tile.stamen.js?v1.3.0"></script>
		<!--Bootstrap Script -->
			<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
		<script>
			document.getElementById("map").style.height = window.innerHeight+"px";
			$(window).resize(function(){document.getElementById("map").style.height = window.innerHeight+"px"});
			var mapLong = -1;
			var mapLat = 55;
			var mapZoom = 6;
			var map = L.map("map",{zoomControl:false}).setView([mapLat, mapLong],mapZoom);
			var layer = new L.StamenTileLayer("toner");
			layer.addTo(map);
			var customIcon = L.icon({
				iconUrl: 'icon.png',
				iconSize:     [30, 30],
				iconAnchor:   [15, 15],
				popupAnchor:  [0, -10]
			});
			var zoom = L.control.zoom({position:"bottomleft"});
			zoom.addTo(map);
		</script>
		<script>
			function codeLookup(){
				var codeSearch = document.getElementById("searchCode").value;
				if(codeSearch != null || codeSearch != undefined || codeSearch != ""){
					codeSearch = codeSearch.toUpperCase();
					fetchLatLong(codeSearch).done(function(response){
							if(response.status == "200"){
								if(response.result[0]["result"] != null){
									var LAT = Number(response.result[0]["result"]["latitude"]);
									var LONG = Number(response.result[0]["result"]["longitude"]);
									var MSOA = response.result[0]["result"]["msoa"];
									var CCG = response.result[0]["result"]["ccg"];
									var CCGCODE = response.result[0]["result"]["codes"]["ccg"];
									var COUNTY = response.result[0]["result"]["admin_county"];
									var OUTCODE = response.result[0]["result"]["outcode"];
									var COUNCIL = response.result[0]["result"]["admin_district"];
									if (COUNCIL.indexOf(" ") != -1){
										splitCOUNCIL = COUNCIL.split(" ");
										lengthCOUNCIL = splitCOUNCIL.length;
										COUNCIL = splitCOUNCIL[lengthCOUNCIL-1]
									}
									var codeMarker = L.marker([LAT,LONG], {icon:customIcon}).addTo(map);
									map.setView([LAT,LONG],10);
									var popUpString = "Postcode: " + codeSearch + "<br>" + "MSOA: " + MSOA + "<br>" + "CCG: " + CCG + "<br>" + "Local Government: <a href='http://www."+COUNCIL+".gov.uk' target='_blank'>"+COUNCIL+" Council</a>";
									codeMarker.bindPopup(popUpString);
									fetchNHSProviders(codeSearch).done(function(response){
										console.log(response);
									});
								}
								else{
									alert("The postcode you have entered was not recognised!")
								}
							}
					});
				}
				else{
					alert("Please type in a postcode before pressing Search");
				}
			}
			function fetchLatLong (POSTCODE){
				var postcodes = {"postcodes":[POSTCODE]};
				return $.ajax({	url: 'https://api.postcodes.io/postcodes?q=[postcodes]',
								type: 'POST',
								data: JSON.stringify(postcodes),
								contentType: "application/json; charset=utf-8",
								async: true
								});
			}
			
			function fetchProviders (PARTIALCODE){
				return $.ajax({ url: 'https://data.gov.uk/data/api/service/health/social_care_locations/partial_postcode?partial_postcode='+PARTIALCODE,
								type: 'POST',
								contentType: "application/json; charset=utf-8",
								async: true
							});
			}
			function fetchNHSProviders (POSTCODE){
				var xhttp = new XMLHttpRequest();
				xhttp.onreadystatechange = function(){
					if (xhttp.readySTate == 4&& xhttp.status == 200){
						return (xhttp.responseText);
					}
				};
				xhttp.open(
					"GET",
					'http://v1.syndication.nhschoices.nhs.uk/organisations/careproviders/postcode/'+POSTCODE+'.xml?apikey=CGQUUEFU&range=5',
					true
				);
				xhttp.send();
			}
		</script>
	</body>
</html>
